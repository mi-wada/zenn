---
title: "runnでTable driven test"
emoji: "🐈"
type: "tech"
topics:
  - "Go"
  - "runn"
  - "API"
published: true
---

## はじめに

最近仕事でAPIのE2Eテストツールとして[runn](https://github.com/k1LoW/runn)を使っています。シンプルな記述でテストケースをかける点と、E2Eのテストケースを負荷テストに転用できる点が気に入っています。

この記事では、runnでTable driven testを実装する方法を紹介します。Table driven testについては[Go Wiki: TableDrivenTests](https://go.dev/wiki/TableDrivenTests)をご覧ください。

## 実装

以下のリポジトリにサンプルコードを載せています。

https://github.com/mi-wada/runn_table_driven_test

今回は以下の2つのテストケースを実装します。

* `GET https://httpbin.org?q=hello` を呼び出すと、`200 OK` かつ `{"args":{"q":"hello"}}`を含むレスポンスボディを返す。
* `GET https://httpbin.org?q=world` を呼び出すと、`200 OK` かつ `{"args":{"q":"world"}}`を含むレスポンスボディを返す。

以下のファイルに全テストケースを記述します。テストケース毎に異なる引数や期待する値を書きます。

レスポンスのアサーションは`./parts/get.yaml`で行います。`./parts/get.yaml`はrunnの[include機能](https://github.com/k1LoW/runn?tab=readme-ov-file#include-runner-include-other-runbook)を使って読み込んでいます。

```yaml:e2e/e2e.yaml
desc: GET /get
steps:
  - include:
      path: ./parts/get.yaml
      vars:
        q: "hello"
        want_status: 200
        want_body_args: |
          {
            "q": "hello"
          }
  - include:
      path: ./parts/get.yaml
      vars:
        q: "world"
        want_status: 200
        want_body_args: |
          {
            "q": "world"
          }
```

`./parts/get.yaml`は以下のような内容です。e2e.yamlで各テストケース毎に定義したvarsに基づきHTTPリクエストを行いレスポンスをアサートします。

API_BASE_URLは環境変数として設定しています。

なお、`test`フィールドでは[expr-lang/expr](https://github.com/expr-lang/expr)の記法が使えます[^1]。

[^1]: <https://github.com/k1LoW/runn?tab=readme-ov-file#expression-evaluation-engine>

```yaml:e2e/parts/get.yaml
runners:
  req: ${API_BASE_URL}
steps:
  - req:
      /get?q={{ vars.q }}:
        get:
          body: null
    test: |
      steps[0].res.status == vars.want_status &&
      steps[0].res.body.args == fromJSON(vars.want_body_args)
```

API_BASE_URLは以下のように.envファイルで定義しています。.envファイルはrunnの実行時に[--enf-fileオプション](https://github.com/k1LoW/runn/blob/20d1c931ca36136bb342a85e168fe82e2c69c94e/cmd/run.go#L152)で`runn run --env-file .env`のように指定することで環境変数として展開されます。

```plaintext:e2e/.env
API_BASE_URL=https://httpbin.org
```

そして以下のコマンドでテストを実行します。複数のテストケースが実行されていることが確認できます🎉

```console
$ runn run --verbose --env-file ./e2e/.env e2e/e2e.yaml
=== GET /get (e2e/e2e.yaml)
    --- (0) ... ok
        === Generated by `runn new` (e2e/parts/get.yaml)
            --- (0) ... ok
    --- (1) ... ok
        === Generated by `runn new` (e2e/parts/get.yaml)
            --- (0) ... ok


1 scenario, 0 skipped, 0 failures
```

## おわりに

runn便利ですね。
